{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if historique %}Edit History{% else %}New History{% endif %} - Beta Lab
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<link rel="stylesheet" href="{% static "css/editThene.css" %}">
<style>
</style>
{% endblock %}

{% block header_content %}
<div class="page-header animated-gradient">
    <h1 class="page-title fade-in">
        {% if historique %}Edit Theme History{% else %}New Theme History{% endif %}
    </h1>
    <div class="header-line"></div>
    <p class="page-subtitle fade-in delay-200">
        {% if membre %}For {{ membre.user.first_name }} {{ membre.user.last_name }}{% endif %}
    </p>
</div>
{% endblock %}

{% block content %}
<section class="admin-section">
    <div class="container">
        <div class="form-container">
            <div class="form-card">
                <div class="form-header">
                    <h2>
                        {% if historique %}Edit History{% else %}Create History{% endif %}
                    </h2>
                    <a href="{% url 'labo:gestion_historique_themes' %}" class="btn-back">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
                
                {% if messages %}
                    <div class="messages">
                        {% for message in messages %}
                            <div class="message message-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <form method="post" class="historique-form">
                    {% csrf_token %}
                    
                    <!-- In the Member section, replace with: -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <h3><i class="fas fa-user"></i> Member</h3>
                        </div>
                        
                        {% if membre and not historique %}
                            <!-- Display of pre-selected member -->
                            <div class="membre-preselectionne">
                                <div class="membre-info-display">
                                    {% if membre.photo %}
                                        <img src="{{ membre.photo.url }}" alt="{{ membre }}" class="membre-avatar-small">
                                    {% else %}
                                        <div class="avatar-placeholder-small">{{ membre.user.first_name|first }}{{ membre.user.last_name|first }}</div>
                                    {% endif %}
                                    <div>
                                        <h4>{{ membre.user.first_name }} {{ membre.user.last_name }}</h4>
                                        <p>{{ membre.titre }}</p>
                                    </div>
                                </div>
                                {{ form.membre }}  <!-- Hidden field -->
                            </div>
                        {% else %}
                            <!-- Normal member selection -->
                            <div class="form-group">
                                <label for="{{ form.membre.id_for_label }}">{{ form.membre.label }}</label>
                                {{ form.membre }}
                                {% if form.membre.errors %}
                                    <div class="form-errors">
                                        {% for error in form.membre.errors %}
                                            <span class="error">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <h3><i class="fas fa-tag"></i> Theme</h3>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.theme.id_for_label }}">{{ form.theme.label }}</label>
                            {{ form.theme }}
                            {% if form.theme.errors %}
                                <div class="form-errors">
                                    {% for error in form.theme.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if membre and not historique %}
                        <div class="info-box" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px; color: #856404;"><i class="fas fa-info-circle"></i> Information</h4>
                            <p style="margin: 0; color: #856404;">
                                If this member already has a current theme, it will be automatically terminated the day before the new start date.
                            </p>
                        </div>
                    {% endif %}
                    <div class="form-section">
                        <div class="form-section-title">
                            <h3><i class="fas fa-calendar"></i> Period</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.date_debut.id_for_label }}">{{ form.date_debut.label }}</label>
                                {{ form.date_debut }}
                                <div class="form-help">{{ form.date_debut.help_text }}</div>
                                {% if form.date_debut.errors %}
                                    <div class="form-errors">
                                        {% for error in form.date_debut.errors %}
                                            <span class="error">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.date_fin.id_for_label }}">{{ form.date_fin.label }}</label>
                                {{ form.date_fin }}
                                <div class="form-help">{{ form.date_fin.help_text }}</div>
                                {% if form.date_fin.errors %}
                                    <div class="form-errors">
                                        {% for error in form.date_fin.errors %}
                                            <span class="error">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <h3><i class="fas fa-comment"></i> Description</h3>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                            {{ form.description }}
                            <div class="form-help">{{ form.description.help_text }}</div>
                            {% if form.description.errors %}
                                <div class="form-errors">
                                    {% for error in form.description.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                   <!-- Replace the form-actions section with: -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="fas fa-save"></i>
                            {% if historique %}Update{% else %}Create History{% endif %}
                        </button>
                        <a href="{% url 'labo:gestion_historique_themes' %}" class="btn btn-secondary" id="cancel-btn">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block extra_js %}<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submit-btn');
    const form = document.querySelector('form');
    
    // Debug to see if button is clickable
    submitBtn.addEventListener('click', function(e) {
        console.log('Button clicked!');
        
        // Check form validity
        if (form.checkValidity()) {
            console.log('Form valid, submitting...');
        } else {
            console.log('Form invalid');
            e.preventDefault();
            
            // âœ… IDENTIFY INVALID FIELDS
            const invalidFields = form.querySelectorAll(':invalid');
            console.log('Invalid fields:');
            invalidFields.forEach(field => {
                console.log('- Field:', field.name, 'Value:', field.value, 'Message:', field.validationMessage);
                
                // Highlight invalid fields
                field.style.border = '2px solid red';
                field.style.backgroundColor = '#ffe6e6';
                
                // Add visible error message
                let errorDiv = field.parentNode.querySelector('.validation-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'validation-error';
                    errorDiv.style.color = 'red';
                    errorDiv.style.fontSize = '0.9rem';
                    errorDiv.style.marginTop = '5px';
                    field.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = field.validationMessage;
            });
            
            // Scroll to first invalid field
            if (invalidFields.length > 0) {
                invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                invalidFields[0].focus();
            }
        }
    });
    
    // Clear errors when user corrects
    form.addEventListener('input', function(e) {
        if (e.target.checkValidity()) {
            e.target.style.border = '';
            e.target.style.backgroundColor = '';
            
            const errorDiv = e.target.parentNode.querySelector('.validation-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    });
    
    // Ensure buttons are visible
    submitBtn.style.display = 'inline-flex';
    submitBtn.style.opacity = '1';
    submitBtn.style.visibility = 'visible';
    
    const cancelBtn = document.getElementById('cancel-btn');
    cancelBtn.style.display = 'inline-flex';
    cancelBtn.style.opacity = '1';
    cancelBtn.style.visibility = 'visible';
});
</script>
{% endblock extra_js %}